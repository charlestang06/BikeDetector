{"cells":[{"cell_type":"markdown","metadata":{"id":"license"},"source":["##### *Copyright 2021 Google LLC*\n","*Licensed under the Apache License, Version 2.0 (the \"License\")*"]},{"cell_type":"code","execution_count":null,"metadata":{"cellView":"both","id":"rKwqeqWBXANA"},"outputs":[],"source":["# Licensed under the Apache License, Version 2.0 (the \"License\");\n","# you may not use this file except in compliance with the License.\n","# You may obtain a copy of the License at\n","#\n","# https://www.apache.org/licenses/LICENSE-2.0\n","#\n","# Unless required by applicable law or agreed to in writing, software\n","# distributed under the License is distributed on an \"AS IS\" BASIS,\n","# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n","# See the License for the specific language governing permissions and\n","# limitations under the License."]},{"cell_type":"code","source":["gpu_info = !nvidia-smi\n","gpu_info = '\\n'.join(gpu_info)\n","if gpu_info.find('failed') >= 0:\n","  print('Not connected to a GPU')\n","else:\n","  print(gpu_info)\n","\n","from psutil import virtual_memory\n","ram_gb = virtual_memory().total / 1e9\n","print('Your runtime has {:.1f} gigabytes of available RAM\\n'.format(ram_gb))\n","\n","if ram_gb < 20:\n","  print('Not using a high-RAM runtime')\n","else:\n","  print('You are using a high-RAM runtime!')"],"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"UPpTl1FQiogN","executionInfo":{"status":"ok","timestamp":1670979909518,"user_tz":300,"elapsed":1241,"user":{"displayName":"Charles Tang","userId":"08254346733793913295"}},"outputId":"2badcdbf-c0fd-4d3c-b5c4-09d2a1009eaf"},"execution_count":1,"outputs":[{"output_type":"stream","name":"stdout","text":["Wed Dec 14 01:05:08 2022       \n","+-----------------------------------------------------------------------------+\n","| NVIDIA-SMI 460.32.03    Driver Version: 460.32.03    CUDA Version: 11.2     |\n","|-------------------------------+----------------------+----------------------+\n","| GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |\n","| Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. |\n","|                               |                      |               MIG M. |\n","|===============================+======================+======================|\n","|   0  A100-SXM4-40GB      Off  | 00000000:00:04.0 Off |                    0 |\n","| N/A   29C    P0    52W / 400W |      0MiB / 40536MiB |      0%      Default |\n","|                               |                      |             Disabled |\n","+-------------------------------+----------------------+----------------------+\n","                                                                               \n","+-----------------------------------------------------------------------------+\n","| Processes:                                                                  |\n","|  GPU   GI   CI        PID   Type   Process name                  GPU Memory |\n","|        ID   ID                                                   Usage      |\n","|=============================================================================|\n","|  No running processes found                                                 |\n","+-----------------------------------------------------------------------------+\n","Your runtime has 89.6 gigabytes of available RAM\n","\n","You are using a high-RAM runtime!\n"]}]},{"cell_type":"markdown","metadata":{"id":"Gb7qyhNL1yWt"},"source":["# Retrain EfficientDet for the Edge TPU with TensorFlow Lite Model Maker"]},{"cell_type":"markdown","source":[],"metadata":{"id":"oYMA2djOXxiV"}},{"cell_type":"code","source":["# jupyter notebook --NotebookApp.allow_origin='https://colab.research.google.com' --port=8888 --NotebookApp.port_retries=0"],"metadata":{"id":"MoKI0j8hXwrf"},"execution_count":null,"outputs":[]},{"cell_type":"code","source":["from google.colab import drive\n","drive.mount('/content/drive')"],"metadata":{"id":"u2eVTwlmIOIk","colab":{"base_uri":"https://localhost:8080/"},"executionInfo":{"status":"ok","timestamp":1670979923602,"user_tz":300,"elapsed":14087,"user":{"displayName":"Charles Tang","userId":"08254346733793913295"}},"outputId":"67ad4b29-b8e8-4307-ace1-b15847e7a0e0"},"execution_count":2,"outputs":[{"output_type":"stream","name":"stdout","text":["Mounted at /content/drive\n"]}]},{"cell_type":"markdown","metadata":{"id":"2vvAObmTqglq"},"source":["## Import the required packages"]},{"cell_type":"code","execution_count":3,"metadata":{"id":"qhl8lqVamEty","colab":{"base_uri":"https://localhost:8080/"},"executionInfo":{"status":"ok","timestamp":1670980000668,"user_tz":300,"elapsed":77072,"user":{"displayName":"Charles Tang","userId":"08254346733793913295"}},"outputId":"9110d94f-1b0b-48b3-82ee-fa1c23fd92f8"},"outputs":[{"output_type":"stream","name":"stdout","text":["\u001b[K     |████████████████████████████████| 577 kB 4.7 MB/s \n","\u001b[K     |████████████████████████████████| 1.1 MB 68.2 MB/s \n","\u001b[K     |████████████████████████████████| 77 kB 7.0 MB/s \n","\u001b[K     |████████████████████████████████| 10.9 MB 90.8 MB/s \n","\u001b[K     |████████████████████████████████| 840 kB 86.7 MB/s \n","\u001b[K     |████████████████████████████████| 238 kB 94.8 MB/s \n","\u001b[K     |████████████████████████████████| 88 kB 1.6 MB/s \n","\u001b[K     |████████████████████████████████| 60.8 MB 241 kB/s \n","\u001b[K     |████████████████████████████████| 3.4 MB 86.3 MB/s \n","\u001b[K     |████████████████████████████████| 1.3 MB 63.4 MB/s \n","\u001b[K     |████████████████████████████████| 128 kB 94.3 MB/s \n","\u001b[K     |████████████████████████████████| 25.3 MB 1.2 MB/s \n","\u001b[K     |████████████████████████████████| 498.0 MB 11 kB/s \n","\u001b[K     |████████████████████████████████| 352 kB 84.9 MB/s \n","\u001b[K     |████████████████████████████████| 1.4 MB 85.9 MB/s \n","\u001b[K     |████████████████████████████████| 5.8 MB 58.6 MB/s \n","\u001b[K     |████████████████████████████████| 462 kB 91.9 MB/s \n","\u001b[K     |████████████████████████████████| 40 kB 6.8 MB/s \n","\u001b[K     |████████████████████████████████| 216 kB 94.7 MB/s \n","\u001b[?25h  Building wheel for fire (setup.py) ... \u001b[?25l\u001b[?25hdone\n"]}],"source":["!pip install -q tflite-model-maker"]},{"cell_type":"code","execution_count":4,"metadata":{"id":"XtxiUeZEiXpt","colab":{"base_uri":"https://localhost:8080/"},"executionInfo":{"status":"ok","timestamp":1670980006355,"user_tz":300,"elapsed":5692,"user":{"displayName":"Charles Tang","userId":"08254346733793913295"}},"outputId":"fd917128-2ee1-4f3e-a083-732b4518533f"},"outputs":[{"output_type":"stream","name":"stderr","text":["/usr/local/lib/python3.8/dist-packages/tensorflow_addons/utils/ensure_tf_install.py:53: UserWarning: Tensorflow Addons supports using Python ops for all Tensorflow versions above or equal to 2.9.0 and strictly below 2.12.0 (nightly versions are not supported). \n"," The versions of TensorFlow you are currently using is 2.8.4 and is not supported. \n","Some things might work, some things might not.\n","If you were to encounter a bug, do not file an issue.\n","If you want to make sure you're using a tested and supported configuration, either change the TensorFlow version or the TensorFlow Addons's version. \n","You can find the compatibility matrix in TensorFlow Addon's readme:\n","https://github.com/tensorflow/addons\n","  warnings.warn(\n"]}],"source":["import numpy as np\n","import os\n","\n","from tflite_model_maker.config import ExportFormat\n","from tflite_model_maker import model_spec\n","from tflite_model_maker import object_detector\n","\n","import tensorflow as tf\n","assert tf.__version__.startswith('2')\n","\n","tf.get_logger().setLevel('ERROR')\n","from absl import logging\n","logging.set_verbosity(logging.ERROR)\n","\n","import tensorflow as tf\n","from tflite_model_maker.config import QuantizationConfig\n","from tflite_model_maker import model_spec\n","from tflite_model_maker import object_detector\n","from tflite_model_maker.object_detector import DataLoader\n","from tensorflow_examples.lite.model_maker.third_party.efficientdet.keras import train\n","from tensorflow_examples.lite.model_maker.third_party.efficientdet.keras import train_lib"]},{"cell_type":"markdown","metadata":{"id":"H0XM-oIfhgQ7"},"source":["## Load the training data\n"]},{"cell_type":"markdown","metadata":{"id":"ZljJ25RAnj5x"},"source":["### (Optional) Load your own Pascal VOC dataset"]},{"cell_type":"markdown","metadata":{"id":"Ei5BahmPn_wR"},"source":["To use your custom dataset, you need to modify a few variables here, such as your ZIP filename, your label map, and the path to your images/annotations:"]},{"cell_type":"code","execution_count":5,"metadata":{"id":"mz_suhWiqc7A","executionInfo":{"status":"ok","timestamp":1670980006356,"user_tz":300,"elapsed":6,"user":{"displayName":"Charles Tang","userId":"08254346733793913295"}}},"outputs":[],"source":["# Your labels map as a dictionary (zero is reserved):\n","label_map = {1: 'Cyclist'} "]},{"cell_type":"code","source":["batch_size = 32 #or whatever batch size you want\n","epochs = 30\n","checkpoint_dir = \"/content/drive/My Drive/STEM_1/dataset/try6/last_layers\" #whatever your checkpoint directory is"],"metadata":{"id":"D-XuHJfr8phM","executionInfo":{"status":"ok","timestamp":1670980006356,"user_tz":300,"elapsed":5,"user":{"displayName":"Charles Tang","userId":"08254346733793913295"}}},"execution_count":6,"outputs":[]},{"cell_type":"markdown","metadata":{"id":"d8Rh3IWRb0xw"},"source":["Now you're ready to train the model with your custom dataset. But before you run the notebook, you should also skip to the [Export to TensorFlow Lite](#scrollTo=_yB_XMpqGlLs) section and change the `TFLITE_FILENAME` and `LABLES_FILENAME` for your exported files.\n","\n","Then run the whole notebook by clicking **Runtime > Run all**."]},{"cell_type":"code","execution_count":7,"metadata":{"id":"KWROlVNA54xZ","executionInfo":{"status":"ok","timestamp":1670980006357,"user_tz":300,"elapsed":5,"user":{"displayName":"Charles Tang","userId":"08254346733793913295"}}},"outputs":[],"source":["# We need to instantiate a separate DataLoader for each split dataset\n","os.chdir('/content/drive/My Drive/STEM_1/dataset')\n","train_data = object_detector.DataLoader(tfrecord_file_patten='/content/drive/My Drive/STEM_1/dataset/onlybike/train1.record', size=12000, label_map=label_map)\n","validation_data = object_detector.DataLoader(\n","      '/content/drive/My Drive/STEM_1/dataset/onlybike/test1.record', size=738, label_map=label_map)"]},{"cell_type":"markdown","metadata":{"id":"S8clx0KPutCM"},"source":["## Select the model spec"]},{"cell_type":"markdown","metadata":{"id":"vn61LJ9QbOPi"},"source":["Model Maker supports the EfficientDet-Lite family of object detection models that are compatible with the Edge TPU. (EfficientDet-Lite is derived from [EfficientDet](https://ai.googleblog.com/2020/04/efficientdet-towards-scalable-and.html), which offers state-of-the-art accuracy in a small model size). There are several model sizes you can choose from:\n","\n","|| Model architecture | Size(MB)* | Latency(ms)** | Average Precision*** |\n","|-|--------------------|-----------|---------------|----------------------|\n","|| EfficientDet-Lite0 | 5.7       | 37.4            | 30.4%               |\n","|| EfficientDet-Lite1 | 7.6       | 56.3            | 34.3%               |\n","|| EfficientDet-Lite2 | 10.2      | 104.6           | 36.0%               |\n","|| EfficientDet-Lite3 | 14.4      | 107.6           | 39.4%               |\n","| <td colspan=4><br><i>* File size of the compiled Edge TPU models. <br/>** Latency measured on a desktop CPU with a Coral USB Accelerator. <br/>*** Average Precision is the mAP (mean Average Precision) on the COCO 2017 validation dataset.</i></td> |"]},{"cell_type":"code","execution_count":8,"metadata":{"id":"SM9gePHw9Jv1","executionInfo":{"status":"ok","timestamp":1670980010485,"user_tz":300,"elapsed":117,"user":{"displayName":"Charles Tang","userId":"08254346733793913295"}}},"outputs":[],"source":["spec = object_detector.EfficientDetLite1Spec(\n","    hparams='grad_checkpoint=True, learning_rate=0.2', \n","    model_dir=checkpoint_dir, \n","    epochs=epochs, \n","    batch_size=batch_size,\n","    steps_per_execution=1, \n","    moving_average_decay=0,\n","    var_freeze_expr='(efficientnet|fpn_cells|resample_p6)',\n","    tflite_max_detections=25, \n","    strategy=None, \n","    tpu=None, \n","    gcp_project=None,\n","    tpu_zone=None, \n","    use_xla=False, \n","    profile=False, \n","    debug=False, \n","    tf_random_seed=111111,\n","    verbose=1\n",")"]},{"cell_type":"markdown","metadata":{"id":"5qjq2UEHCLUi"},"source":["## Specify Configurations"]},{"cell_type":"markdown","metadata":{"id":"2uZkLR6N6gDR"},"source":["Now we need to create our model according to the model spec, load our dataset into the model, specify training parameters, and begin training. \n","\n","Using Model Maker, we accomplished all of that with [`create()`](https://www.tensorflow.org/lite/api_docs/python/tflite_model_maker/object_detector/create):"]},{"cell_type":"code","execution_count":9,"metadata":{"id":"kwlYdTcg63xy","executionInfo":{"status":"ok","timestamp":1670980025325,"user_tz":300,"elapsed":14842,"user":{"displayName":"Charles Tang","userId":"08254346733793913295"}}},"outputs":[],"source":["detector = object_detector.create(train_data, \n","                                model_spec=spec, \n","                                batch_size=batch_size, \n","                                train_whole_model=True, \n","                                validation_data=validation_data,\n","                                epochs = epochs,\n","                                do_train = False\n","                                )"]},{"cell_type":"code","source":["train_ds, steps_per_epoch, _ = detector._get_dataset_and_steps(train_data, batch_size, is_training = True)\n","validation_ds, validation_steps, val_json_file = detector._get_dataset_and_steps(validation_data, batch_size, is_training = False)"],"metadata":{"id":"1Rz7H_G693dI","executionInfo":{"status":"ok","timestamp":1670980026621,"user_tz":300,"elapsed":1308,"user":{"displayName":"Charles Tang","userId":"08254346733793913295"}}},"execution_count":10,"outputs":[]},{"cell_type":"code","source":["model = detector.create_model()"],"metadata":{"id":"xgfZUdCm94O9","executionInfo":{"status":"ok","timestamp":1670980041457,"user_tz":300,"elapsed":14839,"user":{"displayName":"Charles Tang","userId":"08254346733793913295"}}},"execution_count":11,"outputs":[]},{"cell_type":"code","source":["config = spec.config\n","config.update(\n","    dict(\n","        steps_per_epoch=steps_per_epoch,\n","        eval_samples=batch_size * validation_steps,\n","        val_json_file=val_json_file,\n","        batch_size=batch_size\n","    )\n",")\n","train.setup_model(model, config) #This is the model.compile call basically\n","model.summary()"],"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"4sJWbuob-GSv","executionInfo":{"status":"ok","timestamp":1670980048426,"user_tz":300,"elapsed":1322,"user":{"displayName":"Charles Tang","userId":"08254346733793913295"}},"outputId":"ddae3acf-5a16-4673-8389-eb813b279f0e"},"execution_count":13,"outputs":[{"output_type":"stream","name":"stdout","text":["Model: \"\"\n","_________________________________________________________________\n"," Layer (type)                Output Shape              Param #   \n","=================================================================\n"," keras_layer_1 (KerasLayer)  multiple                  4234512   \n","                                                                 \n"," class_net/class-predict (Se  multiple                 2394      \n"," parableConv2D)                                                  \n","                                                                 \n"," box_net/box-predict (Separa  multiple                 3996      \n"," bleConv2D)                                                      \n","                                                                 \n","=================================================================\n","Total params: 4,240,902\n","Trainable params: 4,177,830\n","Non-trainable params: 63,072\n","_________________________________________________________________\n"]}]},{"cell_type":"markdown","source":["# Train Model"],"metadata":{"id":"XQ-Papje-NT3"}},{"cell_type":"code","source":["try:\n","  #Option A:\n","  #load the weights from the last successfully completed epoch\n","  latest = tf.train.latest_checkpoint(checkpoint_dir) \n","\n","  #Option B:\n","  #load the weights from a specific checkpoint\n","  #latest = specific_checkpoint_dir\n","\n","  completed_epochs = int(latest.split(\"/\")[-1].split(\"-\")[1]) #the epoch the training was at when the training was last interrupted\n","  model.load_weights(latest)\n","\n","  print(\"Checkpoint found {}\".format(latest))\n","except Exception as e:\n","  print(\"Checkpoint not found: \", e)"],"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"1qTiWZbE-MnT","executionInfo":{"status":"ok","timestamp":1670980057715,"user_tz":300,"elapsed":1823,"user":{"displayName":"Charles Tang","userId":"08254346733793913295"}},"outputId":"46bbcdb1-6b89-4229-eeb7-0dda7ab00962"},"execution_count":14,"outputs":[{"output_type":"stream","name":"stdout","text":["Checkpoint found /content/drive/My Drive/STEM_1/dataset/try6/last_layers/ckpt-15\n"]}]},{"cell_type":"code","source":["model.fit(\n","    train_ds,\n","    epochs=epochs,\n","    initial_epoch=completed_epochs, \n","    steps_per_epoch=steps_per_epoch,\n","    validation_data=validation_ds,\n","    validation_steps=validation_steps,\n","    callbacks=train_lib.get_callbacks(config.as_dict(), validation_ds) #This is for saving checkpoints at the end of every epoch\n",")"],"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"2NCtjBgv_xp2","outputId":"c8240567-3292-4a57-b9ec-f3ff05d218b5","executionInfo":{"status":"ok","timestamp":1670985219178,"user_tz":300,"elapsed":5159001,"user":{"displayName":"Charles Tang","userId":"08254346733793913295"}}},"execution_count":15,"outputs":[{"output_type":"stream","name":"stdout","text":["Epoch 16/30\n","375/375 [==============================] - ETA: 0s - det_loss: 0.2409 - cls_loss: 0.1559 - box_loss: 0.0017 - reg_l2_loss: 0.1029 - loss: 0.3439 - learning_rate: 0.0446 - gradient_norm: 0.9956\n","Epoch 16: saving model to /content/drive/My Drive/STEM_1/dataset/try6/last_layers/ckpt-16\n","375/375 [==============================] - 396s 931ms/step - det_loss: 0.2410 - cls_loss: 0.1560 - box_loss: 0.0017 - reg_l2_loss: 0.1029 - loss: 0.3440 - learning_rate: 0.0446 - gradient_norm: 0.9962 - val_det_loss: 0.2032 - val_cls_loss: 0.1505 - val_box_loss: 0.0011 - val_reg_l2_loss: 0.1028 - val_loss: 0.3060\n","Epoch 17/30\n","375/375 [==============================] - ETA: 0s - det_loss: 0.2196 - cls_loss: 0.1446 - box_loss: 0.0015 - reg_l2_loss: 0.1026 - loss: 0.3222 - learning_rate: 0.0393 - gradient_norm: 0.8489\n","Epoch 17: saving model to /content/drive/My Drive/STEM_1/dataset/try6/last_layers/ckpt-17\n","375/375 [==============================] - 336s 896ms/step - det_loss: 0.2194 - cls_loss: 0.1446 - box_loss: 0.0015 - reg_l2_loss: 0.1026 - loss: 0.3220 - learning_rate: 0.0393 - gradient_norm: 0.8484\n","Epoch 18/30\n","375/375 [==============================] - ETA: 0s - det_loss: 0.2131 - cls_loss: 0.1396 - box_loss: 0.0015 - reg_l2_loss: 0.1021 - loss: 0.3152 - learning_rate: 0.0340 - gradient_norm: 0.8076\n","Epoch 18: saving model to /content/drive/My Drive/STEM_1/dataset/try6/last_layers/ckpt-18\n","375/375 [==============================] - 337s 900ms/step - det_loss: 0.2130 - cls_loss: 0.1396 - box_loss: 0.0015 - reg_l2_loss: 0.1021 - loss: 0.3151 - learning_rate: 0.0340 - gradient_norm: 0.8071\n","Epoch 19/30\n","375/375 [==============================] - ETA: 0s - det_loss: 0.1906 - cls_loss: 0.1282 - box_loss: 0.0012 - reg_l2_loss: 0.1016 - loss: 0.2922 - learning_rate: 0.0290 - gradient_norm: 0.7435\n","Epoch 19: saving model to /content/drive/My Drive/STEM_1/dataset/try6/last_layers/ckpt-19\n","375/375 [==============================] - 335s 894ms/step - det_loss: 0.1905 - cls_loss: 0.1282 - box_loss: 0.0012 - reg_l2_loss: 0.1016 - loss: 0.2921 - learning_rate: 0.0290 - gradient_norm: 0.7428\n","Epoch 20/30\n","375/375 [==============================] - ETA: 0s - det_loss: 0.1880 - cls_loss: 0.1269 - box_loss: 0.0012 - reg_l2_loss: 0.1011 - loss: 0.2891 - learning_rate: 0.0242 - gradient_norm: 0.7627\n","Epoch 20: saving model to /content/drive/My Drive/STEM_1/dataset/try6/last_layers/ckpt-20\n","375/375 [==============================] - 354s 944ms/step - det_loss: 0.1880 - cls_loss: 0.1269 - box_loss: 0.0012 - reg_l2_loss: 0.1011 - loss: 0.2891 - learning_rate: 0.0242 - gradient_norm: 0.7621\n","Epoch 21/30\n","375/375 [==============================] - ETA: 0s - det_loss: 0.1852 - cls_loss: 0.1236 - box_loss: 0.0012 - reg_l2_loss: 0.1006 - loss: 0.2859 - learning_rate: 0.0198 - gradient_norm: 0.7322\n","Epoch 21: saving model to /content/drive/My Drive/STEM_1/dataset/try6/last_layers/ckpt-21\n","375/375 [==============================] - 338s 901ms/step - det_loss: 0.1851 - cls_loss: 0.1236 - box_loss: 0.0012 - reg_l2_loss: 0.1006 - loss: 0.2858 - learning_rate: 0.0198 - gradient_norm: 0.7318\n","Epoch 22/30\n","375/375 [==============================] - ETA: 0s - det_loss: 0.1715 - cls_loss: 0.1178 - box_loss: 0.0011 - reg_l2_loss: 0.1002 - loss: 0.2717 - learning_rate: 0.0156 - gradient_norm: 0.7109\n","Epoch 22: saving model to /content/drive/My Drive/STEM_1/dataset/try6/last_layers/ckpt-22\n","375/375 [==============================] - 337s 898ms/step - det_loss: 0.1715 - cls_loss: 0.1178 - box_loss: 0.0011 - reg_l2_loss: 0.1002 - loss: 0.2717 - learning_rate: 0.0156 - gradient_norm: 0.7104\n","Epoch 23/30\n","375/375 [==============================] - ETA: 0s - det_loss: 0.1726 - cls_loss: 0.1176 - box_loss: 0.0011 - reg_l2_loss: 0.0999 - loss: 0.2725 - learning_rate: 0.0119 - gradient_norm: 0.7166\n","Epoch 23: saving model to /content/drive/My Drive/STEM_1/dataset/try6/last_layers/ckpt-23\n","375/375 [==============================] - 336s 897ms/step - det_loss: 0.1728 - cls_loss: 0.1177 - box_loss: 0.0011 - reg_l2_loss: 0.0999 - loss: 0.2727 - learning_rate: 0.0119 - gradient_norm: 0.7164\n","Epoch 24/30\n","375/375 [==============================] - ETA: 0s - det_loss: 0.1689 - cls_loss: 0.1157 - box_loss: 0.0011 - reg_l2_loss: 0.0997 - loss: 0.2686 - learning_rate: 0.0086 - gradient_norm: 0.7325\n","Epoch 24: saving model to /content/drive/My Drive/STEM_1/dataset/try6/last_layers/ckpt-24\n","375/375 [==============================] - 336s 897ms/step - det_loss: 0.1690 - cls_loss: 0.1158 - box_loss: 0.0011 - reg_l2_loss: 0.0997 - loss: 0.2687 - learning_rate: 0.0086 - gradient_norm: 0.7328\n","Epoch 25/30\n","375/375 [==============================] - ETA: 0s - det_loss: 0.1634 - cls_loss: 0.1129 - box_loss: 0.0010 - reg_l2_loss: 0.0995 - loss: 0.2629 - learning_rate: 0.0058 - gradient_norm: 0.7169\n","Epoch 25: saving model to /content/drive/My Drive/STEM_1/dataset/try6/last_layers/ckpt-25\n","375/375 [==============================] - 355s 946ms/step - det_loss: 0.1634 - cls_loss: 0.1129 - box_loss: 0.0010 - reg_l2_loss: 0.0995 - loss: 0.2629 - learning_rate: 0.0058 - gradient_norm: 0.7167\n","Epoch 26/30\n","375/375 [==============================] - ETA: 0s - det_loss: 0.1656 - cls_loss: 0.1131 - box_loss: 0.0010 - reg_l2_loss: 0.0994 - loss: 0.2650 - learning_rate: 0.0036 - gradient_norm: 0.7216\n","Epoch 26: saving model to /content/drive/My Drive/STEM_1/dataset/try6/last_layers/ckpt-26\n","375/375 [==============================] - 336s 895ms/step - det_loss: 0.1658 - cls_loss: 0.1133 - box_loss: 0.0011 - reg_l2_loss: 0.0994 - loss: 0.2652 - learning_rate: 0.0036 - gradient_norm: 0.7229\n","Epoch 27/30\n","375/375 [==============================] - ETA: 0s - det_loss: 0.1583 - cls_loss: 0.1098 - box_loss: 9.6937e-04 - reg_l2_loss: 0.0993 - loss: 0.2576 - learning_rate: 0.0018 - gradient_norm: 0.7104\n","Epoch 27: saving model to /content/drive/My Drive/STEM_1/dataset/try6/last_layers/ckpt-27\n","375/375 [==============================] - 335s 892ms/step - det_loss: 0.1581 - cls_loss: 0.1097 - box_loss: 9.6800e-04 - reg_l2_loss: 0.0993 - loss: 0.2574 - learning_rate: 0.0018 - gradient_norm: 0.7096\n","Epoch 28/30\n","375/375 [==============================] - ETA: 0s - det_loss: 0.1609 - cls_loss: 0.1113 - box_loss: 9.9183e-04 - reg_l2_loss: 0.0992 - loss: 0.2601 - learning_rate: 6.8396e-04 - gradient_norm: 0.7195\n","Epoch 28: saving model to /content/drive/My Drive/STEM_1/dataset/try6/last_layers/ckpt-28\n","375/375 [==============================] - 337s 898ms/step - det_loss: 0.1609 - cls_loss: 0.1113 - box_loss: 9.9189e-04 - reg_l2_loss: 0.0992 - loss: 0.2601 - learning_rate: 6.8293e-04 - gradient_norm: 0.7198\n","Epoch 29/30\n","375/375 [==============================] - ETA: 0s - det_loss: 0.1706 - cls_loss: 0.1153 - box_loss: 0.0011 - reg_l2_loss: 0.0992 - loss: 0.2698 - learning_rate: 9.8130e-05 - gradient_norm: 0.7964\n","Epoch 29: saving model to /content/drive/My Drive/STEM_1/dataset/try6/last_layers/ckpt-29\n","375/375 [==============================] - 336s 897ms/step - det_loss: 0.1705 - cls_loss: 0.1152 - box_loss: 0.0011 - reg_l2_loss: 0.0992 - loss: 0.2697 - learning_rate: 9.7869e-05 - gradient_norm: 0.7955\n","Epoch 30/30\n","375/375 [==============================] - ETA: 0s - det_loss: 0.1588 - cls_loss: 0.1090 - box_loss: 9.9523e-04 - reg_l2_loss: 0.0992 - loss: 0.2580 - learning_rate: 9.7349e-05 - gradient_norm: 0.7393\n","Epoch 30: saving model to /content/drive/My Drive/STEM_1/dataset/try6/last_layers/ckpt-30\n","375/375 [==============================] - 355s 947ms/step - det_loss: 0.1588 - cls_loss: 0.1090 - box_loss: 9.9573e-04 - reg_l2_loss: 0.0992 - loss: 0.2580 - learning_rate: 9.7865e-05 - gradient_norm: 0.7397\n"]},{"output_type":"execute_result","data":{"text/plain":["<keras.callbacks.History at 0x7f71007f5d30>"]},"metadata":{},"execution_count":15}]},{"cell_type":"markdown","metadata":{"id":"_yB_XMpqGlLs"},"source":["## Export to TensorFlow Lite"]},{"cell_type":"markdown","metadata":{"id":"CgCDMe0e6jlT"},"source":["Next, we'll export the model to the TensorFlow Lite format. By default, the [`export()`](https://www.tensorflow.org/lite/api_docs/python/tflite_model_maker/object_detector/ObjectDetector#export) method performs [full integer post-training quantization](https://www.tensorflow.org/lite/performance/post_training_quantization#full_integer_quantization), which is exactly what we need for compatibility with the Edge TPU. (Model Maker uses the same dataset we gave to our model spec as a representative dataset, which is required for full-int quantization.)\n","\n","We just need to specify the export directory and format. By default, it exports to TF Lite, but we also want a labels file, so we declare both:"]},{"cell_type":"code","execution_count":16,"metadata":{"id":"2Cu9cxX5Qu-e","executionInfo":{"status":"ok","timestamp":1670985219606,"user_tz":300,"elapsed":50,"user":{"displayName":"Charles Tang","userId":"08254346733793913295"}}},"outputs":[],"source":["TFLITE_FILENAME = 'efficientdet-lite-bikes.tflite'\n","LABELS_FILENAME = 'bikes-labels.txt'"]},{"cell_type":"code","source":["export_dir = \"/content/drive/My Drive/STEM_1/dataset/try6\"\n","quant_config = QuantizationConfig.for_float16()\n","detector.model = model\n","detector.export(export_dir = export_dir, tflite_filename=TFLITE_FILENAME, quantization_config = quant_config, label_filename=LABELS_FILENAME,\n","             export_format=[ExportFormat.TFLITE, ExportFormat.LABEL])"],"metadata":{"id":"Ro397qcBAXV2","executionInfo":{"status":"ok","timestamp":1670985279187,"user_tz":300,"elapsed":59585,"user":{"displayName":"Charles Tang","userId":"08254346733793913295"}}},"execution_count":17,"outputs":[]},{"cell_type":"markdown","metadata":{"id":"b94hZ-exOCRB"},"source":["### Evaluate the TF Lite model"]},{"cell_type":"code","execution_count":18,"metadata":{"id":"RS3Ell_lqH4e","colab":{"base_uri":"https://localhost:8080/"},"executionInfo":{"status":"ok","timestamp":1670985354043,"user_tz":300,"elapsed":74868,"user":{"displayName":"Charles Tang","userId":"08254346733793913295"}},"outputId":"f9d3a6d8-519c-4062-d735-4332efeb05b5"},"outputs":[{"output_type":"stream","name":"stdout","text":[" 738/1000 [=====================>........] - ETA: 24s\n"]},{"output_type":"execute_result","data":{"text/plain":["{'AP': 0.80254364,\n"," 'AP50': 0.97720975,\n"," 'AP75': 0.91792554,\n"," 'APs': 0.006631579,\n"," 'APm': 0.46136823,\n"," 'APl': 0.82380015,\n"," 'ARmax1': 0.4828385,\n"," 'ARmax10': 0.83063,\n"," 'ARmax100': 0.83425057,\n"," 'ARs': 0.2,\n"," 'ARm': 0.6137615,\n"," 'ARl': 0.85365856,\n"," 'AP_/Cyclist': 0.80254364}"]},"metadata":{},"execution_count":18}],"source":["detector.evaluate_tflite(\"/content/drive/My Drive/STEM_1/dataset/try6/\"+TFLITE_FILENAME, validation_data)"]}],"metadata":{"colab":{"provenance":[{"file_id":"1DRNsZW-6-CQsR7p0i_49Z1dolM_8xyPN","timestamp":1667792635346},{"file_id":"https://github.com/google-coral/tutorials/blob/master/retrain_efficientdet_model_maker_tf2.ipynb","timestamp":1667756742492}]},"kernelspec":{"display_name":"Python 3","name":"python3"},"gpuClass":"premium","accelerator":"GPU"},"nbformat":4,"nbformat_minor":0}